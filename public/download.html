<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnonDrop - Scarica File</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>Scarica File</h1>
        <p>Il tuo file Ã¨ pronto per essere scaricato.</p>
        
        <div id="fileInfo" class="drop-zone" style="border-style: solid; cursor: default;">
            <i class="fas fa-file-download" style="font-size: 48px; margin-bottom: 20px;"></i>
            <div style="margin-bottom: 10px;">
                <span style="color: #888; font-size: 0.9rem;">Nome file:</span><br>
                <strong id="fileName" style="font-size: 1.1rem; color: #fff;">Caricamento...</strong>
            </div>
            <div>
                <span style="color: #888; font-size: 0.9rem;">Dimensione:</span><br>
                <strong id="fileSize" style="font-size: 1.1rem; color: #fff;">Caricamento...</strong>
            </div>
        </div>

        <button id="downloadButton" disabled>Scarica Ora</button>
        
        <p id="errorMessage" class="error-message"></p>

        <div style="margin-top: 30px;">
            <a href="/" style="color: var(--primary-color); text-decoration: none; font-size: 0.9rem;">
                <i class="fas fa-arrow-left"></i> Invia un altro file
            </a>
        </div>
    </div>

    <script>
        const fileNameElement = document.getElementById('fileName');
        const fileSizeElement = document.getElementById('fileSize');
        const downloadButton = document.getElementById('downloadButton');
        const errorMessageElement = document.getElementById('errorMessage');

        const pathParts = window.location.pathname.split('/');
        const fileId = pathParts[pathParts.length - 1];

        if (!fileId) {
            errorMessageElement.textContent = 'Link di download non valido.';
            errorMessageElement.style.display = 'block';
        } else {
            fetch(`/.netlify/functions/download-info/${fileId}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'File non trovato o scaduto'); });
                    }
                    return response.json();
                })
                .then(data => {
                    fileNameElement.textContent = data.fileName;
                    fileSizeElement.textContent = formatBytes(data.fileSize);
                    downloadButton.disabled = false;
                    downloadButton.addEventListener('click', () => {
                        window.location.href = data.downloadUrl;
                    });
                })
                .catch(error => {
                    console.error('Error fetching download info:', error);
                    errorMessageElement.textContent = `Errore: ${error.message}`;
                    errorMessageElement.style.display = 'block';
                    fileNameElement.textContent = 'N/A';
                    fileSizeElement.textContent = 'N/A';
                });
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
